# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. GitHub 'Actions' íƒ­ì— ì´ ì´ë¦„ì´ í‘œì‹œë©ë‹ˆë‹¤.
name: AI Security Scan

# ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì§€ì •í•˜ëŠ” íŠ¸ë¦¬ê±°(trigger) ì„¤ì •ì…ë‹ˆë‹¤.
on:
  # 'main' ë¸Œëœì¹˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” Pull Requestê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  pull_request:
    branches: [main]

# ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‹¤í–‰ë  ì‹¤ì œ ì‘ì—…(job)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  # 'security-scan' ì´ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—…ì„ ì •ì˜í•©ë‹ˆë‹¤.
  security-scan:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤. (ìµœì‹  ìš°ë¶„íˆ¬)
    runs-on: ubuntu-latest

    # ì‘ì—… ì•ˆì—ì„œ ì‹¤í–‰ë  ë‹¨ê³„(step)ë“¤ì„ ìˆœì„œëŒ€ë¡œ ë‚˜ì—´í•©ë‹ˆë‹¤.
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      #    actions/checkout ì•¡ì…˜ì„ ì‚¬ìš©í•´ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Python í™˜ê²½ ì„¤ì •
      #    actions/setup-python ì•¡ì…˜ì„ ì‚¬ìš©í•´ íŠ¹ì • ë²„ì „ì˜ íŒŒì´ì¬ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      #    Day 2ì—ì„œ ì‚¬ìš©í–ˆë˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ê³¼ checkovë¥¼ pipìœ¼ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install Python dependencies
        run: |
          pip install google-generativeai requests python-dotenv checkov

      # 4. Terraform ì„¤ì¹˜
      #    checkovê°€ Terraform ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
      #    hashicorp/setup-terraform ì•¡ì…˜ì„ ì‚¬ìš©í•´ Terraformì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 5. Checkov ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
      #    checkovë¥¼ ì‹¤í–‰í•˜ì—¬ result.json íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
      #    'continue-on-error: true'ëŠ” ì·¨ì•½ì ì´ ë°œê²¬ë˜ì–´ë„(ì—ëŸ¬ ì½”ë“œ ë°œìƒ) ì›Œí¬í”Œë¡œìš°ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê²Œ í•´ì¤ë‹ˆë‹¤.
      - name: Run Checkov scan
        run: checkov -f main.tf -o json > result.json
        continue-on-error: true

      # 6. ìŠ¤ìº” ê²°ê³¼ë¬¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
      #    ìƒì„±ëœ result.json íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸(artifact)ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      #    ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì´ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ìŠ¤ìº”ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆì–´ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: result.json

      # --- ğŸ”½ ì´ ë¶€ë¶„ì„ íŒŒì¼ ë§¨ ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”! ğŸ”½ ---
      # 7. AI ë¶„ì„ ë° ëŒ“ê¸€ ì‘ì„±
      #    ìˆ˜ì •ëœ main.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ìµœì¢… ëª©í‘œë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤.
      - name: Run AI analysis and post comment
        run: python main.py
        env:
          # Day 3ì— ì €ì¥ì†Œ Secretsì— ë“±ë¡í•œ í‚¤ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GHA_TOKEN }}

          # GitHub Actionsê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜ë“¤ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
          # github.repositoryëŠ” 'ì†Œìœ ì/ì €ì¥ì†Œì´ë¦„' í˜•ì‹ì…ë‹ˆë‹¤. ì˜ˆ: 'cabege/ai-security-bot'
          REPO_NAME: ${{ github.repository }}
          # github.event.pull_request.numberëŠ” í˜„ì¬ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰ì‹œí‚¨ PRì˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.
          PR_NUMBER: ${{ github.event.pull_request.number }}
